<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mist Jarvis SDK 4.5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      background: #f9f9f9;
    }
    .block {
      max-width: 600px;
      margin: auto;
      background: #ffffff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
    }
    button {
      padding: 10px 16px;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 6px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="block">
    <h2>üß† Mist Jarvis SDK 4.5</h2>
    <p>–û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç Kommo...</p>
    <div id="result" style="margin-top:20px;"></div>
  </div>

  <script>
    window.KommoWidget = {
      init: async function(app) {
        const context = await app.context();
        console.log("–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—É—á–µ–Ω:", context);

        const analysis = await fetch("https://mist-chat-widget-production.up.railway.app/messages/" + context.id)
          .then(r => r.json())
          .then(data => fetch("https://mist-chat-widget-production.up.railway.app/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ messages: data.messages })
          }).then(res => res.json()))
          .catch(() => null);

        if (!analysis) {
          return app.render({ html: "<div style='color:red;'>‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.</div>" });
        }

        app.render({
          html: `
            <h3>–ê–Ω–∞–ª–∏–∑ –ø–æ —Å–¥–µ–ª–∫–µ #${context.id}</h3>
            <pre>
<b>–¶–µ–ª–∏:</b> ${analysis.goals}
<b>–°–æ–º–Ω–µ–Ω–∏—è:</b> ${analysis.doubts}
<b>–û—Ç–≤–µ—Ç—ã –º–µ–Ω–µ–¥–∂–µ—Ä–∞:</b> ${analysis.manager_score}
<b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b> ${analysis.recommendation}
            </pre>`
        });
      }
    };
  </script>
</body>
</html>
